import React, { useState, useEffect } from 'react';
import { User, Trash2, Shield, CheckCircle, XCircle } from 'lucide-react';
import toast from 'react-hot-toast';const AdminUsers = () => {  const [users, setUsers] = useState([]);  const [loading, setLoading] = useState(true);  useEffect(() => {    fetchUsers();  }, []);  // ดึงข้อมูลผู้ใช้ทั้งหมด  const fetchUsers = async () => {    try {      setLoading(true);      const { auth } = await import('../../config/firebase');      const idToken = await auth.currentUser?.getIdToken();            if (!idToken) {        toast.error('กรุณาเข้าสู่ระบบใหม่');        return;      }      const response = await fetch('http://127.0.0.1:5001/oskconnectdb/us-central1/api/admin/users', {        headers: {          'Authorization': `Bearer ${idToken}`,          'Content-Type': 'application/json'        }      });      if (response.ok) {        const data = await response.json();        setUsers(data.data || []);      } else {        toast.error('ไม่สามารถโหลดข้อมูลผู้ใช้ได้');      }    } catch (error) {      console.error('Error fetching users:', error);      toast.error('เกิดข้อผิดพลาดในการโหลดข้อมูล');    } finally {      setLoading(false);    }  };  // อนุมัติผู้ใช้  const approveUser = async (userId) => {    try {      const { auth } = await import('../../config/firebase');      const idToken = await auth.currentUser?.getIdToken();            if (!idToken) {        toast.error('กรุณาเข้าสู่ระบบใหม่');        return;      }      const response = await fetch(`http://127.0.0.1:5001/oskconnectdb/us-central1/api/admin/users/${userId}/status`, {        method: 'PUT',        headers: {          'Authorization': `Bearer ${idToken}`,          'Content-Type': 'application/json'        },        body: JSON.stringify({          role: 'member',          status: 'approved'        })      });      if (response.ok) {        toast.success('อนุมัติผู้ใช้สำเร็จ');        fetchUsers();      } else {        toast.error('ไม่สามารถอนุมัติผู้ใช้ได้');      }    } catch (error) {      console.error('Error approving user:', error);      toast.error('เกิดข้อผิดพลาดในการอนุมัติ');    }  };  // ลบผู้ใช้  const deleteUser = async (userId, userEmail) => {    try {      const { auth } = await import('../../config/firebase');      const idToken = await auth.currentUser?.getIdToken();            if (!idToken) {        toast.error('กรุณาเข้าสู่ระบบใหม่');        return;      }      const response = await fetch(`http://127.0.0.1:5001/oskconnectdb/us-central1/api/admin/users/${userId}`, {        method: 'DELETE',        headers: {          'Authorization': `Bearer ${idToken}`        }      });      if (response.ok) {        toast.success('ลบผู้ใช้สำเร็จ');        fetchUsers();      } else {        const data = await response.json();        toast.error(data.error || 'ไม่สามารถลบผู้ใช้ได้');      }    } catch (error) {      console.error('Error deleting user:', error);      toast.error('เกิดข้อผิดพลาดในการลบผู้ใช้');    }  };  if (loading) {    return (      <div className="flex justify-center items-center h-64">        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>      </div>    );  }  return (    <div className="container mx-auto px-4 py-8">      <div className="bg-white rounded-lg shadow-sm">        <div className="p-6">          <div className="flex justify-between items-center mb-6">            <h2 className="text-2xl font-bold text-gray-800">จัดการผู้ใช้งาน</h2>            <button              onClick={fetchUsers}              className="px-4 py-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100"            >              รีเฟรช            </button>          </div>          <div className="overflow-x-auto">            <table className="min-w-full divide-y divide-gray-200">              <thead className="bg-gray-50">                <tr>                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">                    ชื่อ-นามสกุล                  </th>                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">                    อีเมล                  </th>                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">                    สถานะ                  </th>                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">                    รุ่น                  </th>                  <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">                    จัดการ                  </th>                </tr>              </thead>              <tbody className="bg-white divide-y divide-gray-200">                {users.map((user) => (                  <tr key={user.id} className={user.status === 'pending' ? 'bg-yellow-50' : ''}>                    <td className="px-6 py-4 whitespace-nowrap">                      <div className="flex items-center">                        <div className="flex-shrink-0 h-10 w-10 bg-gray-100 rounded-full flex items-center justify-center">                          <User className="h-6 w-6 text-gray-500" />                        </div>                        <div className="ml-4">                          <div className="text-sm font-medium text-gray-900">                            {user.firstName} {user.lastName}                          </div>                        </div>                      </div>                    </td>                    <td className="px-6 py-4 whitespace-nowrap">                      <div className="text-sm text-gray-900">{user.email}</div>                    </td>                    <td className="px-6 py-4 whitespace-nowrap">                      <div className="flex items-center">                        {user.role === 'admin' ? (                          <span className="px-3 py-1 text-sm rounded-full bg-purple-100 text-purple-700 flex items-center">                            <Shield className="h-4 w-4 mr-1" />                            ผู้ดูแลระบบ                          </span>                        ) : user.status === 'pending' ? (                          <span className="px-3 py-1 text-sm rounded-full bg-yellow-100 text-yellow-700">                            รอการอนุมัติ                          </span>                        ) : user.status === 'approved' ? (                          <span className="px-3 py-1 text-sm rounded-full bg-green-100 text-green-700">                            สมาชิก                          </span>                        ) : (                          <span className="px-3 py-1 text-sm rounded-full bg-gray-100 text-gray-700">                            {user.status}                          </span>                        )}                      </div>                    </td>                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">                      {user.generation || '-'}                    </td>                    <td className="px-6 py-4 whitespace-nowrap text-center">                      <div className="flex items-center justify-center space-x-2">                        {user.status === 'pending' && (                          <button                            onClick={() => {                              if (window.confirm(`ต้องการอนุมัติผู้ใช้ "${user.firstName} ${user.lastName}" ใช่หรือไม่?`)) {                                approveUser(user.id);                              }                            }}                            className="p-2 bg-green-50 text-green-600 rounded-lg hover:bg-green-100"                            title="อนุมัติ"                          >                            <CheckCircle className="h-5 w-5" />                          </button>                        )}                        <button                          onClick={() => {                            if (window.confirm(`ต้องการลบผู้ใช้ "${user.firstName} ${user.lastName}" ใช่หรือไม่?`)) {                              deleteUser(user.id, user.email);                            }                          }}                          className="p-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100"                          title="ลบผู้ใช้"                        >                          <Trash2 className="h-5 w-5" />                        </button>                      </div>                    </td>                  </tr>                ))}              </tbody>            </table>          </div>          {users.length === 0 && (            <div className="text-center py-12">              <User className="mx-auto h-12 w-12 text-gray-400" />              <h3 className="mt-2 text-sm font-medium text-gray-900">ไม่มีผู้ใช้</h3>              <p className="mt-1 text-sm text-gray-500">ยังไม่มีผู้ใช้ในระบบ</p>            </div>          )}        </div>      </div>    </div>  );};export default AdminUsers;